<!-- TOC -->

- [分布式架构几大基础组件](#分布式架构几大基础组件)
- [CAP理论](#cap理论)
  - [一致性（C）](#一致性c)
  - [可用性（A）](#可用性a)
  - [分区容错性（P）](#分区容错性p)

<!-- /TOC -->

# 分布式架构几大基础组件
|名称|描述|案例|
|---|---|---|
|服务注册与发现|记录当前可用的微服务实例的网络信息数据库，是服务发现机制的主要核心。服务调用方从服务注册中心找到自己需要调用的服务的地址。可以选择客户端服务发现，也可以选择服务端服务发现。|Eureka/Zookeeper/Consul|
|负载均衡|服务提供方一般以多实例的形式提供服务，负载均衡功能能够让服务调用方连接到合适的服务节点，并且节点选择的工作对服务调用方来说是透明的。可以选择服务端的负载均衡，也可以选择客户端的负载均衡。|Robbin|
|服务网关|服务网关是服务调用的唯一入口，可以在这个组件是实现用户鉴权、动态路由、灰度发布、A/B测试、负载限流等功能。|Zuul/Gateway|
|配置中心|将本地化的配置信息（Properties、XML、YAML等）注册到配置中心，实现程序包在开发、测试、生产环境的无差别性，方便程序包的迁移。配置部分可以单独使用高可用的分布式配置中心，确保一个配置服务出现问题时，其他服务也能够提供配置服务。|Spring Cloud Config/consul|
|服务调用熔断与降级|**熔断**：当某服务出现不可用或响应超时的情况时，为了防止整个系统出现雪崩，暂时停止对该服务的调用。</br> </br>**降级**：对某些负荷会比较高的情况，为了预防某些功能（业务场景）出现负荷过载或者响应慢的情况，在其内部暂时舍弃对一些非核心的接口和数据的请求，而直接返回一个提前准备好的fallback（退路）错误处理信息。这样，虽然提供的是一个有损的服务，但却保证了整个系统的稳定性和可用性。|Hystrix,Robbin,Feign|
|API管理|以方便的形式编写及更新API文档，并以方便的形式供调用者查看和测试。|Swagger|
|分布式事务|对于重要的业务，需要通过分布式事务技术（TCC、高可用消息服务、***努力通知）保证数据的一致性。根据业务的不同，适当地牺牲一些数据的一致性要求，确保数据的最终一致性。||
|调用链|记录完成一个业务逻辑时调用到的微服务，并将这种串行或并行的调用关系展示出来。在系统出错时，可以方便地找到出错点。|zipkin|
|支撑平台|系统微服务化后，系统变得更加碎片化，系统的部署、运维、监控等都比单体架构更加复杂，那么就需要将大部分的工作自动化。现在，可以通过Docker等工具来中和这些微服务架构带来的弊端。例如，持续集成、蓝绿发布、健康检查、性能健康等。可以这么说，如果没有合适的支撑平台或工具，就不要使用微服务架构。|Spring Cloud|

# CAP理论
*CAP理论的基础是集群，如果服务不是以集群的方式存在的，那么也就无从谈起CAP的设计。*

CAP是3个英文单词的首字母：C-Consistency（一致性），A-Availability（可用性），Partition tolerance（分区容错性）。    
## 一致性（C）
在分布式系统中的所有数据备份，在同一时刻是否同样的值。（等同于所有节点访问同一份最新的数据副本）
这就要求数据在多个副本之间，当一个系统在数据一致的状态下执行更新操作后，应该保证系统的数据仍然处于一致的状态。

对于一个将数据副本分布在不同分布式节点上的系统来说，如果对第一个节点的数据进行了更新操作并且更新成功后，却没有使得第二个系统的数据得到响应的更新，于是在对第二个节点的数据进行读取操作时，获取的依然是老数据（或者称为脏数据），这就是典型的分布式数据不一致情况。在分布式系统中，如果能够做到针对一个数据项的更新操作执行成功后，所有的用户都可以读取到最新的值，那么这样的系统就被认为具有强一致性。

## 可用性（A）
可用性是指系统提供的服务必须一致处于可用的状态，对于每一个用户的操作请求都能够在有限的时限内返回结果。

## 分区容错性（P）
分区容错性约束一个分布式系统具有如下特性：分布式系统在遇到任何网络分区故障的时候，仍然需要能够保证对外提供满足一致性和可用性的服务，除非是整个网络环境都发生了故障。    
**网络分区：** 指在分布式系统中，不同的节点分布在不同的子网络（机房或者异地网络）中，由于一些特殊原因导致这些子网络之间出现网络不通的情况，但各个子网络的内部网络是正常的，从而导致整个系统的网络环境被切分成若干个孤立的区域。

**CAP理论告诉我们，一个分布式系统不可能同时满足一致性、可用性、分区容错性这三个基本要求，最多只能同时满足其中两项。所以架构师在设计系统时应该将精力放在如何取舍上，而不是如何设计同时满足三者的系统。**

1. Eureka
Eureka的设计满足了 AP 的要求。但是我们要知道这并不是就放弃一致性，只是放弃了强一致性，因为它是要保证最终一致性的。

2. Consol/Zookeeper/
这两者的设计满足了 CP 的要求。这两者集群的设计都是存在主从关系的。当每个节点的数据更新时，其他节点会暂时暂停提供正常的服务，直至所有的节点数据都保持同步。

